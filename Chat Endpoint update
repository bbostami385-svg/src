app.post("/chat", async (req, res) => {
  const { message, username } = req.body;

  if (!message || !username) {
    return res.status(400).json({ error: "Message and username required" });
  }

  const user = userPlans[username];
  if (!user) return res.status(403).json({ error: "User not registered" });

  // Start timer if first message
  if (!user.startTime) user.startTime = Date.now();

  const elapsed = Date.now() - user.startTime;

  // Check if 1 hour passed
  if (elapsed > user.timeLimit) {
    return res.status(403).json({ error: "Free 1-hour limit over. Please upgrade to Premium!" });
  }

  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4.1-mini",
      messages: [{ role: "user", content: message }]
    });

    res.json({
      reply: response.choices[0].message.content,
      timeLeft: Math.max(0, Math.floor((user.timeLimit - elapsed) / 1000)) // seconds left
    });
  } catch (error) {
    res.status(500).json({ error: "AI response failed" });
  }
});