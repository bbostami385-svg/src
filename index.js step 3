// index.js
import express from "express";
import cors from "cors";
import OpenAI from "openai";

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// OpenAI instance
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// Free / Premium user setup
const userPlans = {
  free_user: { timeLimit: 60 * 60 * 1000, startTime: null }, // à§§ à¦˜à¦¨à§à¦Ÿà¦¾ = 60 à¦®à¦¿à¦¨à¦¿à¦Ÿ
  premium_user: { timeLimit: Infinity, startTime: Date.now() }
};

// Test route
app.get("/", (req, res) => {
  res.json({
    status: "OK",
    message: "Bayojid AI backend is running ðŸš€"
  });
});

// Chat endpoint with Free 1-hour / Premium logic
app.post("/chat", async (req, res) => {
  const { message, username } = req.body;

  if (!message || !username) {
    return res.status(400).json({ error: "Message and username required" });
  }

  const user = userPlans[username];
  if (!user) return res.status(403).json({ error: "User not registered" });

  // Start timer if first message
  if (!user.startTime) user.startTime = Date.now();

  const elapsed = Date.now() - user.startTime;

  // Check Free 1-hour limit
  if (elapsed > user.timeLimit) {
    return res.status(403).json({ error: "Free 1-hour limit over. Please upgrade to Premium!" });
  }

  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4.1-mini",
      messages: [{ role: "user", content: message }]
    });

    res.json({
      reply: response.choices[0].message.content,
      timeLeft: Math.max(0, Math.floor((user.timeLimit - elapsed) / 1000)) // seconds left
    });
  } catch (error) {
    res.status(500).json({ error: "AI response failed" });
  }
});

app.listen(PORT, () => console.log(`Server running on port ${PORT}`));